---
title: "Lomatium bradshawii"
author: "Elizabeth Hiroyasu"
date: "Tuesday, May 19, 2015"
output: html_document
---

This analysis explores the use of the demographic trend package for the species Lomatium bradshawii, Bradshaw's desert parsley. This is an endangered, herbaceous perennial that occurs in Oregon and Washington. Primary threats to L. bradshawii are habitat loss. To download the matrix population data for this species, visit the compadre website at 
http://www.compadre-db.org.

# Data loading
## Load in the Compadre data and take the default selection
The data file needs to be in the working directory. It can be downloaded from http://www.compadre-db.org.

```{r}
library(DemographicTrend)
Compadre_file <- "COMPADRE_10_11_2014_version_3.0.Rdata"
mydata <- Load_Compadre_Data(Compadre_file)
```

## Subset the data to the focal species
```{r}
LoBr<-subset(mydata$metadata, SpeciesAuthor=="Lomatium_bradshawii")

#pulling out LoBr Matrices
save<-as.numeric(rownames(LoBr))
MatrixData<- as.array(mydata$mat[mydata$metadata$SpeciesAuthor=="Lomatium_bradshawii"])
MatClass<-mydata$mat_class[save]
```

create vector of active stages
```{r}
active_stages<-subset(MatClass[[1]]$MatrixClassNumber, MatClass[[1]]$MatrixClassOrganized=='active')
```

## Pull out the matrices
```{r}
##pulling out LoBr survival matrices
surv_mat<-(extract_mat(MatrixData))$"survival matrices"

##pulling out LoBr fertility matrices
fert_mat<-(extract_mat(MatrixData))$"fertility matrices"

##pulling out LoBr transition matrices
trans_mat<-(extract_mat(MatrixData))$"transition matrices"
```

# Analysis
First, we will generate N0 vectors from the transition matrices using the DemographicTrend package:

```{r, gen_N0}
N0_data<-gen_N0(trans_mat)
```


To introduce simulations to compare p-values using the functions in the Demographic Trend Package:
```{r}
return_pv<-replicate(10000, calc_pv(surv_mat, fert_mat, N0_data, nstage, years=1:10, stage2mod=1:3, beta=0.1))

```
This code can be adjusted to increase the number of replications and returns a list of p-values for the survival and abundance regressions.

To look at differences in survival and lambda:
```{r}
alpha<-seq(from=0.01, to=0.2, by=0.001)

survival_pv<-unlist(return_pv[1,])
abundance_pv<-unlist(return_pv[2,])
lambda_pv<-unlist(return_pv[3,])

prop_demog<-pv_lessthan_alpha(survival_pv, alpha)
prop_N<-pv_lessthan_alpha(abundance_pv,alpha)
prop_lambda<-pv_lessthan_alpha(lambda_pv, alpha)

diff_mean<-sum(prop_demog-prop_lambda)
delta<-0.01

```

```{r, echo=FALSE}
plot(prop_demog~alpha, type='l',col='blue', xlab='alpha', ylab='freq p<alpha', main='Frequency p is less than alpha')
lines(prop_lambda~alpha, col='red')
legend("bottomright", c("Survival p-values", "Lambda p-values"), col=c("blue","red"), lty=c(1,1))


plot(survival_pv~lambda_pv, col=c("blue", "red"), xlim=c(0,0.05), ylim=c(0,0.05))
abline(0,1)
legend("topleft", c("Survival p-values", "Lambda p-values"), col=c("blue","red"), lty=c(1,1))
```
