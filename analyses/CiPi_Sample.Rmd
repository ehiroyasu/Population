---
title: "CiPi_Analysis"
author: "Elizabeth Hiroyasu"
date: "Wednesday, May 06, 2015"
output: html_document
---

This is a sample analysis using the demographic trend package for a population of Cirsium pitcheri.

# Data loading
## Load in the Compadre data and take the default selection
The data file needs to be in the working directory. It can be downloaded from http://www.compadre-db.org.


```{r}
library(DemographicTrend)

CompadreFile <- "COMPADRE_10_11_2014_version_3.0.Rdata"
mydata <- Load_Compadre_Data(CompadreFile)
```


Subset the data to the focal species
```{r}
CiPi<-subset(mydata$metadata, Population=="CiPi 1")

#extracting CiPi Matrices
save<-as.numeric(rownames(CiPi))
MatrixData<- as.array(mydata$mat[mydata$metadata$Population=="CiPi 1"])
MatClass<-mydata$mat_class[save]
```

create vector of active stages
```{r}
active_stages<-subset(MatClass[[1]]$MatrixClassNumber, MatClass[[1]]$MatrixClassOrganized=='active')
```


Extract the matrices
```{r}
##pulling out CiPi survival matrices
surv_mat<-(extract_mat(MatrixData))$"survival matrices"

##pulling out CiPi fertility matrices
fert_mat<-(extract_mat(MatrixData))$"fertility matrices"

##pulling out CiPi transition matrices
trans_mat<-(extract_mat(MatrixData))$"transition matrices"
```


Creating N0 data
```{r}
#calculating the number of stages in the matrix:
nstage<-1:dim(surv_mat)[1]

N0_data<-gen_N0(trans_mat)

```

To introduce simulations to compare p-values using the functions in the Demographic Trend Package:
```{r}
return_pv<-replicate(1000, calc_pv(surv_mat, fert_mat, N0_data, nstage, years=1:10, stage2mod=1:3, beta=0.01))

```
This code can be adjusted to increase the number of replications and returns a list of p-values for the survival and abundance regressions.

To look at differences in survival and lambda:
```{r}
delta<-0.001
alpha<-seq(from=0.01, to=0.2, by=delta)


survival_pv<-unlist(return_pv[1,])
abundance_pv<-unlist(return_pv[2,])
lambda_pv<-unlist(return_pv[3,])

prop_demog<-pv_lessthan_alpha(pvalue=survival_pv, alpha)
prop_N<-pv_lessthan_alpha(pvalue=abundance_pv,alpha)
prop_lambda<-pv_lessthan_alpha(pvalue=lambda_pv, alpha)

diff<-sum(prop_demog-prop_lambda)
```

```{r, echo=FALSE}
plot(prop_demog~alpha, type='l',col='blue', xlab='alpha', ylab='freq p<alpha', main='Frequency p is less than alpha')
lines(prop_lambda~alpha, col='red')
```
