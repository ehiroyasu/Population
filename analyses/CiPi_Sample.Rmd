---
title: "CiPi_Analysis"
author: "Elizabeth Hiroyasu"
date: "Wednesday, May 06, 2015"
output: html_document
---

This is a sample analysis using the demographic trend package for a population of Cirsium pitcheri.

# Data loading
## Load in the Compadre data and take the default selection
The data file needs to be in the working directory. It can be downloaded from http://www.compadre-db.org.


```{r}
library(DemographicTrend)
CompadreFile <- "COMPADRE_10_11_2014_version_3.0.Rdata"
mydata <- Load_Compadre_Data(CompadreFile)
```


## Subset the data to the focal species
```{r}
CiPi<-subset(mydata$metadata, Population=="CiPi 1")

#pulling out CiPi Matrices
save<-as.numeric(rownames(CiPi))
MatrixData<- as.array(mydata$mat[save])
MatrixData<- as.array(mydata$mat[mydata$metadata$Population=="CiPi 1"])
```


## Pull out the matrices
```{r}
##pulling out CiPi survival matrices
surv_mat<-(extract_mat(MatrixData))$"survival matrices"

##pulling out CiPi fertility matrices
fert_mat<-(extract_mat(MatrixData))$"fertility matrices"

##pulling out CiPi transition matrices
trans_mat<-(extract_mat(MatrixData))$"transition matrices"
```

#calculating the number of stages in the matrix:
nstage<-1:dim(surv_mat)[1]

##Loading the N0 vectors:
N0_data <- load_N0()

##subsetting the data for cipi data
cipi_nx<- subset(N0_data, POP =="CIPI_1")
nx_str<- cipi_nx$Nx
N0_data<-output_N0(nx_str, years=1:10, nstage)

To introduce simulations to compare p-values using the functions in the Demographic Trend Package:
```{r}
return_pv<-replicate(20, calc_pv(surv_mat, fert_mat, N0_data, nstage, years=1:10, stage2mod=1:3, beta=0.01))

single_pv<-calc_pv(surv_mat, fert_mat, N0_data, nstage, years=1:10, stage2mod=1:3, beta=0.01)
```
This code can be adjusted to increase the number of replications and returns a list of p-values for the survival and abundance regressions.

To look at differences in survival and abundance:

alpha<-seq(from=0.01, to=0.2, by=0.01)

survival_pv<-unlist(return_pv[1,])
abundance_pv<-unlist(return_pv[2,])
lambda_pv<-unlist(return_pv[3,])

prop_demog<-surv_lessthan_alpha(survival_pv, alpha)
prop_N<-abundance_lessthan_alpha(abundance_pv,alpha)

diff_mean<-sum(prop_demog-prop_N)
delta<-0.01
power<-diff_mean*delta

```{r, echo=FALSE}
plot(prop_demog~alpha, col='blue', xlab='freq p<alpha', ylab='alpha', main='Frequence p is less than alpha')
lines(n_pv~alpha, col='red')
```
